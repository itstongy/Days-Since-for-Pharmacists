<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Days Since (for Pharmacists)</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #f7f8fb;
      --fg: #0f172a;
      --muted: #475569;
      --card: #ffffff;
      --border: #e5e7eb;
      --shadow: 0 10px 25px rgba(15, 23, 42, 0.06);
      --accent: #2563eb;
      --accent2: #0ea5e9;
      --good: #16a34a;
      --warn: #f59e0b;
      --bad: #ef4444;
      --barbg: #eef2ff;
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--fg);
      position: relative;
    }

    /* Very subtle pharmacy-ish emoji background */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: 0.035;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='320' height='320'%3E%3Ctext x='18' y='62' font-size='28'%3E%F0%9F%92%8A%3C/text%3E%3Ctext x='112' y='98' font-size='26'%3E%F0%9F%92%89%3C/text%3E%3Ctext x='230' y='64' font-size='26'%3E%F0%9F%A9%BA%3C/text%3E%3Ctext x='40' y='170' font-size='26'%3E%F0%9F%A9%BA%3C/text%3E%3Ctext x='190' y='168' font-size='26'%3E%F0%9F%A7%BE%3C/text%3E%3Ctext x='250' y='210' font-size='26'%3E%F0%9F%93%84%3C/text%3E%3Ctext x='90' y='260' font-size='26'%3E%F0%9F%92%8A%3C/text%3E%3Ctext x='20' y='300' font-size='24'%3E%F0%9F%94%AC%3C/text%3E%3Ctext x='220' y='302' font-size='24'%3E%F0%9F%A7%AA%3C/text%3E%3C/svg%3E");
      background-repeat: repeat;
      filter: grayscale(100%);
    }

    .wrap {
      max-width: 920px;
      margin: 0 auto;
      padding: 24px 16px 56px;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 22px;
      letter-spacing: -0.01em;
    }

    p {
      margin: 0 0 16px;
      color: var(--muted);
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      margin: 16px 0;
      box-shadow: var(--shadow);
    }

    /* Pastel card accents */
    .card-days {
      background: linear-gradient(180deg, #eef2ff, #ffffff 75%);
      border-color: #dbe3ff;
    }
    .card-med {
      background: linear-gradient(180deg, #ecfdf5, #ffffff 75%);
      border-color: #c7f0dc;
    }
    .card-gauge {
      background: linear-gradient(180deg, #f5f3ff, #ffffff 75%);
      border-color: #e7ddff;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 780px) {
      .grid { grid-template-columns: 2fr 1fr 1fr; }
      .grid.results { grid-template-columns: 1fr 1fr 1fr; }
    }

    label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--fg);
      outline: none;
    }

    input:focus {
      border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 18%, transparent);
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    button {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 12%, #fff), #fff);
      color: var(--fg);
      cursor: pointer;
    }

    button:hover { filter: brightness(0.99); }

    /* Small quick-fill buttons */
    .chip {
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 13px;
      background: #fff;
    }

    .statusline {
      color: var(--muted);
      font-size: 13px;
    }

    .center {
      text-align: center;
    }

    .big {
      font-size: 44px;
      font-weight: 800;
      letter-spacing: -0.03em;
      margin: 6px 0 4px;
    }

    .sub {
      color: var(--muted);
      font-size: 13px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 13px;
      background: #fff;
    }

    .pill.good { border-color: color-mix(in srgb, var(--good) 40%, var(--border)); color: color-mix(in srgb, var(--good) 80%, #000); }
    .pill.warn { border-color: color-mix(in srgb, var(--warn) 45%, var(--border)); color: color-mix(in srgb, var(--warn) 90%, #000); }
    .pill.bad  { border-color: color-mix(in srgb, var(--bad) 45%, var(--border));  color: color-mix(in srgb, var(--bad) 90%, #000); }

    .bar {
      width: 100%;
      height: 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--barbg);
      overflow: hidden;
    }

    .bar > div {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius: 999px;
      transition: width 180ms ease;
    }

    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: #fff;
    }

    ul { margin: 8px 0 0; padding-left: 18px; color: var(--muted); }
    li { margin: 6px 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Days Since (for Pharmacists)</h1>
    <p>Fast “days since” + optional supply calculation (date formats: DD/MM, DD/MM/YY, DD/MM/YYYY).</p>

    <div class="card">
      <div class="grid">
        <div>
          <label for="date">Date</label>
          <input id="date" inputmode="numeric" placeholder="e.g. 25/06 or 25/06/25 or 25/06/2025" />
        </div>
        <div>
          <label for="amount">Amount of tablets (optional)</label>
          <input id="amount" inputmode="decimal" placeholder="e.g. 30" />
          <div class="row" style="margin-top: 8px;">
            <button class="chip" type="button" data-set="amount" data-val="28">28</button>
            <button class="chip" type="button" data-set="amount" data-val="30">30</button>
            <button class="chip" type="button" data-set="amount" data-val="56">56</button>
            <button class="chip" type="button" data-set="amount" data-val="84">84</button>
          </div>
        </div>
        <div>
          <label for="perDay">Tablets per day (optional)</label>
          <input id="perDay" inputmode="decimal" placeholder="e.g. 1" />
          <div class="row" style="margin-top: 8px;">
            <button class="chip" type="button" data-set="perDay" data-val="0.5">0.5/day</button>
            <button class="chip" type="button" data-set="perDay" data-val="1">1/day</button>
            <button class="chip" type="button" data-set="perDay" data-val="2">2/day</button>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top: 10px;">
        <div style="flex: 1 1 320px;">
          <label for="buffer">Early supply buffer (days)</label>
          <div class="row" style="gap: 10px; align-items: baseline;">
            <input id="buffer" inputmode="numeric" placeholder="9" style="max-width: 140px;" />
            <span class="sub">Default: 9</span>
          </div>
          <div class="sub" style="margin-top:6px;">✅ if due within buffer (or overdue). ❌ if too early. (Default 9 days)</div>
        </div>
      </div>

      <div class="row" style="margin-top: 12px;">
        <button id="calc">Calculate</button>
        <button id="copy">Copy link</button>
        <span class="statusline" id="status"></span>
      </div>
    </div>

    <!-- Results: three cards -->
    <div id="out" style="display:none;">
      <div class="grid results">
        <div class="card center card-days">
          <div class="sub" style="margin-bottom: 6px;">Days since</div>
          <div class="big" id="days">—</div>
          <div class="row" style="justify-content:center; margin-top: 8px;">
            <span class="pill" id="flag">—</span>
          </div>
          <div class="sub" id="parsed" style="margin-top: 10px;">—</div>
        </div>

        <div class="card card-med" id="medCard" style="display:none;">
          <div class="sub" style="margin-bottom: 6px;">Days left (estimated)</div>
          <div class="big" id="daysLeft">—</div>
          <div class="row" style="margin-top: 8px;">
            <span class="pill" id="due">—</span>
          </div>
          <div class="sub" id="runout" style="margin-top: 10px;">—</div>
          <div class="sub" id="canGet" style="margin-top: 6px;">—</div>
        </div>

        <div class="card card-gauge" id="gaugeCard" style="display:none;">
          <div class="sub" style="margin-bottom: 6px;">Supply gauge</div>
          <div class="bar" aria-label="supply gauge"><div id="barFill"></div></div>
          <div class="row" style="justify-content: space-between; margin-top: 10px;">
            <span class="pill" id="supply">—</span>
            <span class="pill" id="pct">—</span>
          </div>
          <ul id="medDetails"></ul>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="sub" style="margin-bottom: 6px;">Use it like a search engine (fastest)</div>
      <p class="sub" style="margin-top:0;">
        You can set a browser keyword so you can type something like <code>ds 25/06 30 1</code> and instantly get the result.
      </p>
      <ul>
        <li><b>Format:</b> <code>DD/MM</code> or <code>DD/MM/YY</code> or <code>DD/MM/YYYY</code></li>
        <li><b>Optional meds:</b> add <code>amount</code> then <code>perDay</code> (e.g. <code>25/06 60 2</code>)</li>
        <li><b>Optional buffer:</b> add <code>&amp;buffer=9</code> to the URL (default 9)</li>
      </ul>
      <p class="sub" style="margin-top: 12px; margin-bottom: 6px;">URL formats supported:</p>
      <ul>
        <li><code>?s=25/06</code> or <code>?s=25/06/2025</code></li>
        <li><code>?s=25/06 30 1</code> (date, amount, per-day)</li>
        <li><code>?date=25/06/2025&amp;amount=30&amp;perDay=1&amp;buffer=7</code></li>
      </ul>
      <p class="sub" style="margin-top: 12px; margin-bottom: 6px;">How to set up a browser shortcut (Chrome / Edge):</p>
      <ul>
        <li>Open browser settings → <b>Search engine</b> → <b>Manage search engines</b>.</li>
        <li>Click <b>Add</b>.</li>
        <li>Name: <code>Days Since</code></li>
        <li>Shortcut/Keyword: <code>ds</code></li>
        <li>URL: paste the page URL with <code>?s=%s</code> on the end.
          <br/>Example: <code>https://itstongy.github.io/Days-Since-for-Pharmacists/?s=%s</code>
        </li>
        <li>Now in the address bar type: <code>ds 25/06 30 1</code> → Enter.</li>
      </ul>
    </div>
  </div>

  <script>
    function pad2(n) { return String(n).padStart(2, '0'); }

    function startOfDay(d) {
      return new Date(d.getFullYear(), d.getMonth(), d.getDate());
    }

    function daysBetween(a, b) {
      // b - a in whole days
      const ms = startOfDay(b).getTime() - startOfDay(a).getTime();
      return Math.floor(ms / 86400000);
    }

    function clamp(n, lo, hi) { return Math.min(hi, Math.max(lo, n)); }

    function parseFlexibleDate(raw) {
      // Accept DD/MM, DD/MM/YY, DD/MM/YYYY
      const s = (raw || '').trim();
      const m = s.match(/^\s*(\d{1,2})\s*[\/\-\. ]\s*(\d{1,2})(?:\s*[\/\-\. ]\s*(\d{2,4}))?\s*$/);
      if (!m) return { ok: false, error: 'Enter date as DD/MM, DD/MM/YY, or DD/MM/YYYY.' };

      const dd = Number(m[1]);
      const mm = Number(m[2]);
      const yyRaw = m[3];

      if (!(dd >= 1 && dd <= 31 && mm >= 1 && mm <= 12)) {
        return { ok: false, error: 'Invalid day/month.' };
      }

      const today = startOfDay(new Date());
      const currentYear = today.getFullYear();

      let year;
      let inferred = false;

      if (!yyRaw) {
        // No year provided: pick the most recent occurrence.
        year = currentYear;
        inferred = true;
        const candidate = new Date(year, mm - 1, dd);
        if (candidate.getMonth() !== (mm - 1) || candidate.getDate() !== dd) {
          return { ok: false, error: 'That date does not exist.' };
        }
        if (startOfDay(candidate).getTime() > today.getTime()) {
          year = currentYear - 1;
        }
      } else {
        const yNum = Number(yyRaw);
        if (yyRaw.length === 2) {
          // Interpret 2-digit years as 2000-2099.
          year = 2000 + yNum;
        } else {
          year = yNum;
        }
      }

      const date = new Date(year, mm - 1, dd);
      if (date.getMonth() !== (mm - 1) || date.getDate() !== dd) {
        return { ok: false, error: 'That date does not exist.' };
      }

      return { ok: true, date, inferred, input: s };
    }

    function parseNumber(raw) {
      if (raw == null) return null;
      const s = String(raw).trim();
      if (!s) return null;
      const n = Number(s.replace(',', '.'));
      return Number.isFinite(n) ? n : null;
    }

    function pickStatus(days) {
      if (days < 0) return { cls: 'bad', text: 'In the future (check date)' };
      if (days === 0) return { cls: 'warn', text: 'Today' };
      if (days <= 7) return { cls: 'good', text: 'Recent' };
      if (days <= 30) return { cls: 'warn', text: 'A while ago' };
      // Default fallback: keep simple
      return { cls: 'bad', text: '—' };
    }

    function supplyDecision(daysLeft, bufferDays) {
      // Goal: at a glance, is it reasonable to SUPPLY today?
      // - ✅ if due soon (within buffer) OR overdue (ran out already)
      // - ❌ if too early (they should still have plenty left)
      // - ⚠️ if inputs are missing
      if (daysLeft == null) return { cls: 'warn', text: 'Add tablets/day to judge supply' };

      const b = Number.isFinite(bufferDays) ? bufferDays : 9;

      if (daysLeft < 0) {
        return { cls: 'good', text: `✅ Overdue by ${Math.abs(daysLeft)}d (OK to supply)` };
      }
      if (daysLeft <= b) {
        return { cls: 'good', text: `✅ Due soon (${daysLeft}d left)` };
      }
      return { cls: 'bad', text: `❌ Too early (${daysLeft}d left)` };
    }

    function setPill(el, cls, text) {
      el.className = 'pill' + (cls ? ' ' + cls : '');
      el.textContent = text;
    }

    function formatDate(d) {
      return `${pad2(d.getDate())}/${pad2(d.getMonth() + 1)}/${d.getFullYear()}`;
    }

    function compute() {
      const dateRaw = document.querySelector('#date').value;
      const amountRaw = document.querySelector('#amount').value;
      const perDayRaw = document.querySelector('#perDay').value;

      // buffer handled via numeric input (default 9)

      const p = parseFlexibleDate(dateRaw);
      const statusEl = document.querySelector('#status');

      if (!p.ok) {
        statusEl.textContent = p.error;
        document.querySelector('#out').style.display = 'none';
        return;
      }

      const today = startOfDay(new Date());
      const d = startOfDay(p.date);
      const days = daysBetween(d, today);

      document.querySelector('#out').style.display = '';
      document.querySelector('#days').textContent = `${days}`;

      const inferredNote = p.inferred ? ' (year inferred)' : '';
      document.querySelector('#parsed').textContent = `Parsed as ${formatDate(d)}${inferredNote}`;

      // Medication cards
      const amount = parseNumber(amountRaw);
      const perDay = parseNumber(perDayRaw);

      const medCard = document.querySelector('#medCard');
      const gaugeCard = document.querySelector('#gaugeCard');
      const details = document.querySelector('#medDetails');
      details.innerHTML = '';

      let daysLeftForFlag = null;

      if (amount != null && perDay != null && perDay > 0) {
        medCard.style.display = '';
        gaugeCard.style.display = '';

        const daysSupply = amount / perDay;
        const totalDays = Math.max(0, Math.floor(daysSupply));
        const runoutDate = new Date(d.getFullYear(), d.getMonth(), d.getDate() + totalDays);

        const daysLeft = daysBetween(today, runoutDate); // runout - today
        daysLeftForFlag = daysLeft;

        // Days left card
        document.querySelector('#daysLeft').textContent = `${daysLeft}`;
        document.querySelector('#runout').textContent = `Run-out date: ${formatDate(startOfDay(runoutDate))}`;

        let dueCls = 'good';
        let dueText = '';
        if (daysLeft > 0) {
          dueCls = 'good';
          dueText = `Not due yet (${daysLeft}d left)`;
        } else if (daysLeft === 0) {
          dueCls = 'warn';
          dueText = 'Due today (by this estimate)';
        } else {
          dueCls = 'bad';
          dueText = `Overdue by ${Math.abs(daysLeft)}d (by this estimate)`;
        }
        setPill(document.querySelector('#due'), dueCls, dueText);

        // Gauge card
        setPill(document.querySelector('#supply'), 'good', `~${daysSupply.toFixed(daysSupply < 10 ? 1 : 0)} days supply`);

        // Percent remaining (based on whole-day supply)
        const used = clamp(daysBetween(d, today), 0, totalDays);
        const remaining = clamp(totalDays - used, 0, totalDays);
        const pct = totalDays > 0 ? (remaining / totalDays) : 0;

        document.querySelector('#barFill').style.width = `${(pct * 100).toFixed(0)}%`;

        let pctCls = 'good';
        if (pct <= 0.15) pctCls = 'bad';
        else if (pct <= 0.35) pctCls = 'warn';
        setPill(document.querySelector('#pct'), pctCls, `${(pct * 100).toFixed(0)}% remaining`);

        const li1 = document.createElement('li');
        li1.textContent = `Start date: ${formatDate(d)}`;
        const li2 = document.createElement('li');
        li2.textContent = `Amount: ${amount} tablets`;
        const li3 = document.createElement('li');
        li3.textContent = `Rate: ${perDay} tablets/day`;
        const li4 = document.createElement('li');
        li4.textContent = `Estimated run-out: ${formatDate(startOfDay(runoutDate))}`;
        details.append(li1, li2, li3, li4);
      } else {
        medCard.style.display = 'none';
        gaugeCard.style.display = 'none';
      }

      // Supply decision + "can get on" date
      const bufferUi = parseNumber(document.querySelector('#buffer')?.value);
      const buffer = (bufferUi == null ? 9 : bufferUi);

      if (amount != null && perDay != null && perDay > 0) {
        const f = supplyDecision(daysLeftForFlag, buffer);
        setPill(document.querySelector('#flag'), f.cls, f.text);

        const canGetEl = document.querySelector('#canGet');
        const daysUntilOk = Math.max(0, (daysLeftForFlag - buffer));
        const okDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() + daysUntilOk);
        if (daysUntilOk === 0) {
          canGetEl.textContent = 'Can supply: today';
        } else {
          canGetEl.textContent = `Can supply on: ${formatDate(startOfDay(okDate))} (in ${daysUntilOk}d)`;
        }
      } else {
        const st = pickStatus(days);
        setPill(document.querySelector('#flag'), st.cls, st.text);
        const canGetEl = document.querySelector('#canGet');
        if (canGetEl) canGetEl.textContent = 'Add tablets/day to calculate “can supply on” date.';
      }

      statusEl.textContent = '';
    }

    function fillFromQuery() {
      const params = new URLSearchParams(location.search);

      // Support search-engine style: ?s=<stuff>
      const s = params.get('s') || params.get('q') || '';

      if (s) {
        const parts = decodeURIComponent(s).trim().split(/\s+/);
        if (parts[0]) document.querySelector('#date').value = parts[0];
        if (parts[1]) document.querySelector('#amount').value = parts[1];
        if (parts[2]) document.querySelector('#perDay').value = parts[2];
      }

      const date = params.get('date');
      const amount = params.get('amount');
      const perDay = params.get('perDay');
      const buffer = params.get('buffer');
      if (date) document.querySelector('#date').value = date;
      if (amount) document.querySelector('#amount').value = amount;
      if (perDay) document.querySelector('#perDay').value = perDay;
      if (buffer && document.querySelector('#buffer')) document.querySelector('#buffer').value = buffer;

      // buffer input is numeric; default handled in compute()

      if (document.querySelector('#date').value.trim()) {
        compute();
      }
    }

    function buildShareUrl() {
      const date = document.querySelector('#date').value.trim();
      const amount = document.querySelector('#amount').value.trim();
      const perDay = document.querySelector('#perDay').value.trim();
      const buffer = document.querySelector('#buffer')?.value;

      const tokens = [date, amount, perDay].filter(Boolean).join(' ');
      const url = new URL(location.href);
      url.search = '';
      if (tokens) url.searchParams.set('s', tokens);
      if (buffer && buffer !== '9') url.searchParams.set('buffer', buffer);
      return url.toString();
    }

    document.querySelector('#calc').addEventListener('click', compute);
    document.querySelector('#copy').addEventListener('click', async () => {
      const url = buildShareUrl();
      try {
        await navigator.clipboard.writeText(url);
        document.querySelector('#status').textContent = 'Copied link.';
      } catch {
        document.querySelector('#status').textContent = url;
      }
    });

    // Quick-fill buttons
    document.querySelectorAll('button.chip').forEach((btn) => {
      btn.addEventListener('click', () => {
        const key = btn.getAttribute('data-set');
        const val = btn.getAttribute('data-val');
        const input = document.querySelector('#' + key);
        if (input) input.value = val;
        compute();
      });
    });

    // Buffer input updates (keyboard-first): compute on Enter already; also compute on blur/change.
    const bufferEl = document.querySelector('#buffer');
    if (bufferEl) {
      bufferEl.addEventListener('change', compute);
      bufferEl.addEventListener('blur', compute);
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') compute();
    });

    fillFromQuery();
  </script>
</body>
</html>
