<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Days Since (for Pharmacists)</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #f7f8fb;
      --fg: #0f172a;
      --muted: #475569;
      --card: #ffffff;
      --border: #e5e7eb;
      --shadow: 0 10px 25px rgba(15, 23, 42, 0.06);
      --accent: #2563eb;
      --accent2: #0ea5e9;
      --good: #16a34a;
      --warn: #f59e0b;
      --bad: #ef4444;
      --barbg: #eef2ff;
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--fg);
      position: relative;
    }

    /* Very subtle pharmacy-ish emoji background */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: 0.035;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='320' height='320'%3E%3Ctext x='18' y='62' font-size='28'%3E%F0%9F%92%8A%3C/text%3E%3Ctext x='112' y='98' font-size='26'%3E%F0%9F%92%89%3C/text%3E%3Ctext x='230' y='64' font-size='26'%3E%F0%9F%A9%BA%3C/text%3E%3Ctext x='40' y='170' font-size='26'%3E%F0%9F%A9%BA%3C/text%3E%3Ctext x='190' y='168' font-size='26'%3E%F0%9F%A7%BE%3C/text%3E%3Ctext x='250' y='210' font-size='26'%3E%F0%9F%93%84%3C/text%3E%3Ctext x='90' y='260' font-size='26'%3E%F0%9F%92%8A%3C/text%3E%3Ctext x='20' y='300' font-size='24'%3E%F0%9F%94%AC%3C/text%3E%3Ctext x='220' y='302' font-size='24'%3E%F0%9F%A7%AA%3C/text%3E%3C/svg%3E");
      background-repeat: repeat;
      filter: grayscale(100%);
    }

    .wrap {
      max-width: 920px;
      margin: 0 auto;
      padding: 24px 16px 56px;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 22px;
      letter-spacing: -0.01em;
    }

    p {
      margin: 0 0 16px;
      color: var(--muted);
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      margin: 16px 0;
      box-shadow: var(--shadow);
    }

    /* Pastel card accents */
    .card-days {
      background: linear-gradient(180deg, #eef2ff, #ffffff 75%);
      border-color: #dbe3ff;
    }
    .card-med {
      background: linear-gradient(180deg, #ecfdf5, #ffffff 75%);
      border-color: #c7f0dc;
    }
    .card-gauge {
      background: linear-gradient(180deg, #f5f3ff, #ffffff 75%);
      border-color: #e7ddff;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 780px) {
      .grid { grid-template-columns: 2fr 1fr 1fr; }
      .grid.results { grid-template-columns: 1fr 1fr 1fr; }
    }

    label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--fg);
      outline: none;
    }

    input:focus {
      border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 18%, transparent);
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    button {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 12%, #fff), #fff);
      color: var(--fg);
      cursor: pointer;
    }

    button:hover { filter: brightness(0.99); }

    .statusline {
      color: var(--muted);
      font-size: 13px;
    }

    .center {
      text-align: center;
    }

    .big {
      font-size: 44px;
      font-weight: 800;
      letter-spacing: -0.03em;
      margin: 6px 0 4px;
    }

    .sub {
      color: var(--muted);
      font-size: 13px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 13px;
      background: #fff;
    }

    .pill.good { border-color: color-mix(in srgb, var(--good) 40%, var(--border)); color: color-mix(in srgb, var(--good) 80%, #000); }
    .pill.warn { border-color: color-mix(in srgb, var(--warn) 45%, var(--border)); color: color-mix(in srgb, var(--warn) 90%, #000); }
    .pill.bad  { border-color: color-mix(in srgb, var(--bad) 45%, var(--border));  color: color-mix(in srgb, var(--bad) 90%, #000); }

    .bar {
      width: 100%;
      height: 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--barbg);
      overflow: hidden;
    }

    .bar > div {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius: 999px;
      transition: width 180ms ease;
    }

    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: #fff;
    }

    ul { margin: 8px 0 0; padding-left: 18px; color: var(--muted); }
    li { margin: 6px 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Days Since (for Pharmacists)</h1>
    <p>Fast “days since” + optional supply calculation (date formats: DD/MM, DD/MM/YY, DD/MM/YYYY).</p>

    <div class="card">
      <div class="grid">
        <div>
          <label for="date">Date</label>
          <input id="date" inputmode="numeric" placeholder="e.g. 25/06 or 25/06/25 or 25/06/2025" />
        </div>
        <div>
          <label for="amount">Amount of tablets (optional)</label>
          <input id="amount" inputmode="decimal" placeholder="e.g. 30" />
        </div>
        <div>
          <label for="perDay">Tablets per day (optional)</label>
          <input id="perDay" inputmode="decimal" placeholder="e.g. 1" />
        </div>
      </div>

      <div class="row" style="margin-top: 12px;">
        <button id="calc">Calculate</button>
        <button id="copy">Copy link</button>
        <span class="statusline" id="status"></span>
      </div>
    </div>

    <!-- Results: three cards -->
    <div id="out" style="display:none;">
      <div class="grid results">
        <div class="card center card-days">
          <div class="sub" style="margin-bottom: 6px;">Days since</div>
          <div class="big" id="days">—</div>
          <div class="row" style="justify-content:center; margin-top: 8px;">
            <span class="pill" id="flag">—</span>
          </div>
          <div class="sub" id="parsed" style="margin-top: 10px;">—</div>
        </div>

        <div class="card card-med" id="medCard" style="display:none;">
          <div class="sub" style="margin-bottom: 6px;">Days left (estimated)</div>
          <div class="big" id="daysLeft">—</div>
          <div class="row" style="margin-top: 8px;">
            <span class="pill" id="due">—</span>
          </div>
          <div class="sub" id="runout" style="margin-top: 10px;">—</div>
        </div>

        <div class="card card-gauge" id="gaugeCard" style="display:none;">
          <div class="sub" style="margin-bottom: 6px;">Supply gauge</div>
          <div class="bar" aria-label="supply gauge"><div id="barFill"></div></div>
          <div class="row" style="justify-content: space-between; margin-top: 10px;">
            <span class="pill" id="supply">—</span>
            <span class="pill" id="pct">—</span>
          </div>
          <ul id="medDetails"></ul>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="sub" style="margin-bottom: 6px;">Search engine shortcut usage</div>
      <ul>
        <li>Query param: <code>?s=25/06</code> or <code>?s=25/06/2025</code></li>
        <li>With tablets: <code>?s=25/06 30 1</code> (date, amount, per-day)</li>
        <li>Also supports: <code>?date=...</code>, <code>?amount=...</code>, <code>?perDay=...</code></li>
      </ul>
    </div>
  </div>

  <script>
    function pad2(n) { return String(n).padStart(2, '0'); }

    function startOfDay(d) {
      return new Date(d.getFullYear(), d.getMonth(), d.getDate());
    }

    function daysBetween(a, b) {
      // b - a in whole days
      const ms = startOfDay(b).getTime() - startOfDay(a).getTime();
      return Math.floor(ms / 86400000);
    }

    function clamp(n, lo, hi) { return Math.min(hi, Math.max(lo, n)); }

    function parseFlexibleDate(raw) {
      // Accept DD/MM, DD/MM/YY, DD/MM/YYYY
      const s = (raw || '').trim();
      const m = s.match(/^\s*(\d{1,2})\s*[\/\-\. ]\s*(\d{1,2})(?:\s*[\/\-\. ]\s*(\d{2,4}))?\s*$/);
      if (!m) return { ok: false, error: 'Enter date as DD/MM, DD/MM/YY, or DD/MM/YYYY.' };

      const dd = Number(m[1]);
      const mm = Number(m[2]);
      const yyRaw = m[3];

      if (!(dd >= 1 && dd <= 31 && mm >= 1 && mm <= 12)) {
        return { ok: false, error: 'Invalid day/month.' };
      }

      const today = startOfDay(new Date());
      const currentYear = today.getFullYear();

      let year;
      let inferred = false;

      if (!yyRaw) {
        // No year provided: pick the most recent occurrence.
        year = currentYear;
        inferred = true;
        const candidate = new Date(year, mm - 1, dd);
        if (candidate.getMonth() !== (mm - 1) || candidate.getDate() !== dd) {
          return { ok: false, error: 'That date does not exist.' };
        }
        if (startOfDay(candidate).getTime() > today.getTime()) {
          year = currentYear - 1;
        }
      } else {
        const yNum = Number(yyRaw);
        if (yyRaw.length === 2) {
          // Interpret 2-digit years as 2000-2099.
          year = 2000 + yNum;
        } else {
          year = yNum;
        }
      }

      const date = new Date(year, mm - 1, dd);
      if (date.getMonth() !== (mm - 1) || date.getDate() !== dd) {
        return { ok: false, error: 'That date does not exist.' };
      }

      return { ok: true, date, inferred, input: s };
    }

    function parseNumber(raw) {
      if (raw == null) return null;
      const s = String(raw).trim();
      if (!s) return null;
      const n = Number(s.replace(',', '.'));
      return Number.isFinite(n) ? n : null;
    }

    function pickStatus(days) {
      if (days < 0) return { cls: 'bad', text: 'In the future (check date)' };
      if (days === 0) return { cls: 'warn', text: 'Today' };
      if (days <= 7) return { cls: 'good', text: 'Recent' };
      if (days <= 30) return { cls: 'warn', text: 'A while ago' };
      // Default fallback: keep simple
      return { cls: 'bad', text: '—' };
    }

    function pickupFlag(daysLeft) {
      // Requested: ✅ if they have <9 days to go, ❌ otherwise
      if (daysLeft == null) return { cls: 'warn', text: 'Enter tablets to show ✅/❌' };
      if (daysLeft < 9 && daysLeft >= 0) return { cls: 'good', text: '✅ < 9 days left' };
      if (daysLeft < 0) return { cls: 'bad', text: '❌ already overdue' };
      return { cls: 'bad', text: '❌ ≥ 9 days left' };
    }

    function setPill(el, cls, text) {
      el.className = 'pill' + (cls ? ' ' + cls : '');
      el.textContent = text;
    }

    function formatDate(d) {
      return `${pad2(d.getDate())}/${pad2(d.getMonth() + 1)}/${d.getFullYear()}`;
    }

    function compute() {
      const dateRaw = document.querySelector('#date').value;
      const amountRaw = document.querySelector('#amount').value;
      const perDayRaw = document.querySelector('#perDay').value;

      const p = parseFlexibleDate(dateRaw);
      const statusEl = document.querySelector('#status');

      if (!p.ok) {
        statusEl.textContent = p.error;
        document.querySelector('#out').style.display = 'none';
        return;
      }

      const today = startOfDay(new Date());
      const d = startOfDay(p.date);
      const days = daysBetween(d, today);

      document.querySelector('#out').style.display = '';
      document.querySelector('#days').textContent = `${days}`;

      const inferredNote = p.inferred ? ' (year inferred)' : '';
      document.querySelector('#parsed').textContent = `Parsed as ${formatDate(d)}${inferredNote}`;

      // Medication cards
      const amount = parseNumber(amountRaw);
      const perDay = parseNumber(perDayRaw);

      const medCard = document.querySelector('#medCard');
      const gaugeCard = document.querySelector('#gaugeCard');
      const details = document.querySelector('#medDetails');
      details.innerHTML = '';

      let daysLeftForFlag = null;

      if (amount != null && perDay != null && perDay > 0) {
        medCard.style.display = '';
        gaugeCard.style.display = '';

        const daysSupply = amount / perDay;
        const totalDays = Math.max(0, Math.floor(daysSupply));
        const runoutDate = new Date(d.getFullYear(), d.getMonth(), d.getDate() + totalDays);

        const daysLeft = daysBetween(today, runoutDate); // runout - today
        daysLeftForFlag = daysLeft;

        // Days left card
        document.querySelector('#daysLeft').textContent = `${daysLeft}`;
        document.querySelector('#runout').textContent = `Run-out date: ${formatDate(startOfDay(runoutDate))}`;

        let dueCls = 'good';
        let dueText = '';
        if (daysLeft > 0) {
          dueCls = 'good';
          dueText = `Not due yet (${daysLeft}d left)`;
        } else if (daysLeft === 0) {
          dueCls = 'warn';
          dueText = 'Due today (by this estimate)';
        } else {
          dueCls = 'bad';
          dueText = `Overdue by ${Math.abs(daysLeft)}d (by this estimate)`;
        }
        setPill(document.querySelector('#due'), dueCls, dueText);

        // Gauge card
        setPill(document.querySelector('#supply'), 'good', `~${daysSupply.toFixed(daysSupply < 10 ? 1 : 0)} days supply`);

        // Percent remaining (based on whole-day supply)
        const used = clamp(daysBetween(d, today), 0, totalDays);
        const remaining = clamp(totalDays - used, 0, totalDays);
        const pct = totalDays > 0 ? (remaining / totalDays) : 0;

        document.querySelector('#barFill').style.width = `${(pct * 100).toFixed(0)}%`;

        let pctCls = 'good';
        if (pct <= 0.15) pctCls = 'bad';
        else if (pct <= 0.35) pctCls = 'warn';
        setPill(document.querySelector('#pct'), pctCls, `${(pct * 100).toFixed(0)}% remaining`);

        const li1 = document.createElement('li');
        li1.textContent = `Start date: ${formatDate(d)}`;
        const li2 = document.createElement('li');
        li2.textContent = `Amount: ${amount} tablets`;
        const li3 = document.createElement('li');
        li3.textContent = `Rate: ${perDay} tablets/day`;
        const li4 = document.createElement('li');
        li4.textContent = `Estimated run-out: ${formatDate(startOfDay(runoutDate))}`;
        details.append(li1, li2, li3, li4);
      } else {
        medCard.style.display = 'none';
        gaugeCard.style.display = 'none';
      }

      // Flag pill: ✅/❌ based on days left when med inputs are present; fallback otherwise.
      if (amount != null && perDay != null && perDay > 0) {
        const f = pickupFlag(daysLeftForFlag);
        setPill(document.querySelector('#flag'), f.cls, f.text);
      } else {
        const st = pickStatus(days);
        setPill(document.querySelector('#flag'), st.cls, st.text);
      }

      statusEl.textContent = '';
    }

    function fillFromQuery() {
      const params = new URLSearchParams(location.search);

      // Support search-engine style: ?s=<stuff>
      const s = params.get('s') || params.get('q') || '';

      if (s) {
        const parts = decodeURIComponent(s).trim().split(/\s+/);
        if (parts[0]) document.querySelector('#date').value = parts[0];
        if (parts[1]) document.querySelector('#amount').value = parts[1];
        if (parts[2]) document.querySelector('#perDay').value = parts[2];
      }

      const date = params.get('date');
      const amount = params.get('amount');
      const perDay = params.get('perDay');
      if (date) document.querySelector('#date').value = date;
      if (amount) document.querySelector('#amount').value = amount;
      if (perDay) document.querySelector('#perDay').value = perDay;

      if (document.querySelector('#date').value.trim()) {
        compute();
      }
    }

    function buildShareUrl() {
      const date = document.querySelector('#date').value.trim();
      const amount = document.querySelector('#amount').value.trim();
      const perDay = document.querySelector('#perDay').value.trim();

      const tokens = [date, amount, perDay].filter(Boolean).join(' ');
      const url = new URL(location.href);
      url.search = '';
      if (tokens) url.searchParams.set('s', tokens);
      return url.toString();
    }

    document.querySelector('#calc').addEventListener('click', compute);
    document.querySelector('#copy').addEventListener('click', async () => {
      const url = buildShareUrl();
      try {
        await navigator.clipboard.writeText(url);
        document.querySelector('#status').textContent = 'Copied link.';
      } catch {
        document.querySelector('#status').textContent = url;
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') compute();
    });

    fillFromQuery();
  </script>
</body>
</html>
